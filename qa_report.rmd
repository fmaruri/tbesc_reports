
```{r,echo=FALSE, results="as-is",message=FALSE, warning=FALSE,error=FALSE}
# Initialize!

# Stop R from interpreting strings as factors. When you want factors, you'll know it.
options(stringsAsFactors = FALSE)

# Load up the requisite packages
library(to1check)
library(plyr)
library(xtable)

# Load the local info (edit this if your results are wrong)
local_facts <- read.csv("local_facts.csv")

# Load the latest cleaned data
load(local_facts$datapath)

# Set aside those who were successfully enrolled - we'll generally disregard those who declined
# or didn't complete enrollment 
enrolled <- to1clean$master$StudyId[to1clean$master$CloseReason %in% c("Triple Negative", "Open")]


# Set up default print arguments for printing tables:
dfprint <- function(df) {
    print(xtable(df),
          type = "html",
          include.rownames = FALSE,
          NA.string = "-")
}


```

`r paste("# TBESC TO 1 Site Report:", local_facts$site)`

## Enrollment Progress
---------------------
Total Enrollment To Date: `r nrow(subset(to1clean$master, VisitDate >= as.Date(local_facts$period_start)))`

(covering the period `r paste(local_facts$period_start)` through `r paste(local_facts$period_end)`)


```{r,echo=FALSE, results="hide",message=FALSE, warning=FALSE,error=FALSE,fig.width = 12, fig.height = 6}
# Plot enrollment progress to date
enrolled_dates <- to1clean$master$VisitDate[to1clean$master$StudyId %in% enrolled]

enroll_progress_plot(enrolled_dates,
                     target = local_facts$enroll_target,
                     enroll_start = as.Date(local_facts$period_start),
                     enroll_end = as.Date(local_facts$period_end)
)

```

### Participants by Status




### Participants by Country of Origin
```{r,echo=FALSE, results="hide",message=FALSE, warning=FALSE,error=FALSE,fig.width = 8, fig.height = 8}

# Tally up participants by their country of birth
birthco <- arrange(count(to1clean$master, var = "BirthCountry"), freq, BirthCountry)

# BirthCountry == "" indicates a pre-enrolled person
birthco$BirthCountry[birthco$BirthCountry == ""] <- "Pre-enrolled"

# Make BirthCountry a factor - this ensures descending order of the bars
birthco$BirthCountry <- factor(birthco$BirthCountry,  levels = birthco$BirthCountry)



# Plot it
ggplot(birthco, aes(x = BirthCountry, weight = freq)) +
  geom_histogram() +
  coord_flip() +
  labs(title = "Enrollment by country of birth",
       x = "Country of Birth",
       y = "Number Enrolled")

```




### Participants by Language




### Testing Results




## Participants with Action Needed
-----------------------------------

### Participants Eligible for Follow-Up
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
fu_report <- calc_fu(to1clean)

names(fu_report) <- c("StudyID", "Enroll Date", "FU Starts", "Fu Ends", "Eligible for FU",
                      "FU Cycle", "Days Left", "Completed")


if(nrow(fu_report) > 0) { dfprint(fu_report) } else {
  cat("No participants require follow-up at this time.")
} 
```


### Participants with Undocumented Treatments

### Triple-Negative Participants to Close
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
tripnegtoclose <- closed_check(to1clean)

# Pretty names
names(tripnegtoclose) <- c("StudyId", "Status", "TST Neg?", "QFT Neg?",
                           "TSPOT Neg?", "Triple Neg?")

dfprint(tripnegtoclose)
```

## Data Quality Checks
------------------------

### Participants with TSTs Read Outside of the 44-76 Hour Window
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
winprob <- tst_win_check(to1clean)

# xtable craps itself on POSIXct, sadly...
winprob$dt_placed <- as.character(winprob$dt_placed)
winprob$dt_read <- as.character(winprob$dt_read)

# Pretty names
names(winprob) <- c("StudyId",
                    "Date/Time Placed", "Placed By",
                    "Date/Time Read", "Read By",
                    "Hours Between")


dfprint(winprob)
```


### Participants with Missing TST, QFT, or TSPOT Results
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
# Identify participants with a missing test
testres <- compile_results(to1clean)

missingtest <- subset(testres,
                      subset = (is.na(tst) | is.na(qft) | is.na(tspot)) & StudyId %in% enrolled,
                      select = c("StudyId", "tst", "qft", "tspot"))

# Pretty names
names(missingtest) <- c("StudyId", "TST Result", "QFT Result", "TSPOT Result")


dfprint(missingtest)
```


### Participants with Pre-enrollment vs. Calculated Age Discrepancies
Age is calculated from participant's reported date of birth and their visit date.
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
ageprob <- age_check(to1clean)

# Pretty names
names(ageprob)[names(ageprob) %in% "preenroll_age"] <- "Pre-enroll Age"
names(ageprob)[names(ageprob) %in% "calc_age"] <- "Calculated Age"
names(ageprob)[names(ageprob) %in% "age_diff"] <- "Difference"

# xtable craps itself on Dates, sadly...
ageprob$BirthDate <- as.character(ageprob$BirthDate)
ageprob$VisitDate <- as.character(ageprob$VisitDate)

dfprint(ageprob)
```


### Height and Weight
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE,fig.width=8}
htwts <- htwt_check(to1clean)

# Show the plot
htwts$plot
```

```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
# List the outliers

# Slightly nicer names
names(htwts$outlierdf) <- c("StudyId", "Height (inches)", "Weight (pounds)")

cat("Participants with most-outlying heights/weights:")
dfprint(htwts$outlierdf)
```

```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
# List those missing heights or weights

# Slightly nicer names
names(htwts$missingdf) <- c("StudyId", "Height (inches)", "Weight (pounds)")

cat("Enrolled participants missing height and/or weight:")
dfprint(htwts$missingdf)
```


### TSTs with Rare PPD Lot Numbers
```{r,echo=FALSE,results='asis',message=FALSE, warning=FALSE,error=FALSE}
lotfreq <- count(to1clean$skintest, "PpdLotNumber")

rare_tst_lot <- subset(to1clean$skintest,
                       subset = PpdLotNumber %in% lotfreq$PpdLotNumber[lotfreq$freq < 10],
                       select = c("StudyId", "TstPlacedBy", "PpdLotNumber"))

dfprint(arrange(rare_tst_lot, PpdLotNumber))
```

