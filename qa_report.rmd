

<style type="text/css">

body {
  padding-bottom: 20%;
}

table {
  border: 1px solid #808080;
  border-collapse: collapse;
}

th {
  background-color: #1F78B4;
  color: #FFFFFF;
  border: 1px solid #808080;
  padding-right: 20px;
  padding-left: 20px;
}

td {
  border: 1px solid #808080;
  padding-right: 20px;
  padding-left: 20px;
}

.maintitle {
  text-align: left;
  padding-top: 0px;
}

h2 {
  text-align: left;
  padding-top: 80px;
}

h3, h4 {
  padding-top: 30px;
}

hr {
  border: 0;
  height: 1px;
  background: #333;
  background-image: -webkit-linear-gradient(left, #ccc, #333, #ccc); 
  background-image:    -moz-linear-gradient(left, #ccc, #333, #ccc); 
  background-image:     -ms-linear-gradient(left, #ccc, #333, #ccc); 
  background-image:      -o-linear-gradient(left, #ccc, #333, #ccc); 
}

</style>



```{r initialize, echo=FALSE,results='hide',message=FALSE,warning=FALSE}
# Initialize!

# Stop R from interpreting strings as factors. 
# When you want factors, you'll know it.
options(stringsAsFactors = FALSE)

# Load up the requisite packages
library(knitr)     # It's a knitr document, after all...
library(to1check)  # All TO1-related functions
library(plyr)      # For the count() and arrange() functions
library(xtable)    # For printing data.frames nicely
library(lubridate) # For calculating number of weeks remaining

# Set default chunk options
opts_chunk$set(echo = FALSE,
               results = 'asis',
               message = FALSE,
               warning = FALSE,
               error = TRUE)


# Load the local info (edit this if your results are wrong)
local_facts <- read.csv("local_facts.csv")

# Load the latest cleaned data
load(local_facts$datapath)

# Set aside those who were successfully enrolled - we'll generally 
# disregard those who declined
# or didn't complete enrollment 
enrolled <- to1clean$master$StudyId[to1clean$master$CloseReason %in% 
                                    c("Triple Negative", "Open")]


# Set up default print arguments for printing tables:
# xtable() makes data.frames more suitable for display
# format() converts all of the data.frame comments to character*;
# print() writes the xtable object to HTML

# *print() for xtable throws a tantrum over Date and POSIXct variables,
# so they have to be converted to character before printing 

dfprint <- function(df, printdigits = 2) {
    print(
        xtable(format(df, 
                      na.encode = FALSE, 
                      digits = printdigits, 
                      nsmall = printdigits), 
               align = c("l", "l", rep("c", ncol(df) - 1))
        ),
        type = "html",
        include.rownames = FALSE,
        NA.string = "-")
}




```

<h1 class='maintitle'>TBESC TO 1 Site Report: `r local_facts$site`</h1>
<h3 class='maintitle'>Enrollment Period: `r paste(local_facts$period_start, "through", local_facts$period_end)`</h3>
<span class='maintitle'>Report generated on `r format(Sys.time())`</span>

## Enrollment Progress
---------------------
```{r}

# Total enrolled so far (I need a better measure of this)
total_enrolled <- nrow(subset(to1clean$master, VisitDate >= as.Date(local_facts$period_start)))

# Total remaining to meet local target
total_remain <- local_facts$enroll_target - total_enrolled

# Weeks remaining in the enrollment period
weeks_left <- new_interval(Sys.Date(), local_facts$period_end) / 
              duration(num = 1, units = "weeks")

# Average weekly enrollment to make target
weekly_target <- round(total_remain / weeks_left, 1)
```

Total Enrolled to Date: `r total_enrolled`

Enrollment Remaining: `r total_remain`

Weeks Remaining (approximately): `r round(weeks_left, 1)`

Average Weekly Enrollment Required: `r weekly_target`



```{r,results="hide",fig.width = 12, fig.height = 6}
# Plot enrollment progress to date
enrolled_dates <- to1clean$master$VisitDate[to1clean$master$StudyId %in% 
                                            enrolled]

enroll_progress_plot(enrolled_dates,
                     target = local_facts$enroll_target,
                     enroll_start = as.Date(local_facts$period_start),
                     enroll_end = as.Date(local_facts$period_end)
)

```




### Participants by Country of Origin
```{r,results="hide",fig.width = 8, fig.height = 8}

# Tally up participants by their country of birth
birthco <- arrange(count(to1clean$master, var = "BirthCountry"), 
                   freq, BirthCountry)

# BirthCountry = "" or NA indicates a pre-enrolled person
birthco$BirthCountry[birthco$BirthCountry %in% c("", NA)] <- "Pre-enrolled"

# Make BirthCountry a factor - this ensures descending order of the bars
birthco$BirthCountry <- factor(birthco$BirthCountry,  
                               levels = birthco$BirthCountry)



# Plot it
ggplot(birthco, aes(x = BirthCountry, weight = freq)) +
  geom_histogram() +
  coord_flip() +
  labs(title = "Enrollment by country of birth",
       x = "Country of Birth",
       y = "Number Enrolled")

```


```{r}
### Participant Ages
```


### Test Results

```{r,results='hide'}
##################################################
# Summarize participants' individual test results
testres <- compile_results(to1clean)


# Cast all results into a wide table
testwide <- dcast(
                melt(testres,
                     id.var = "StudyId", 
                     measure.var = c("tst", "qft", "tspot")),
                variable ~ value,
                fun.agg = length
)

# Tidy up for printing
# Prettier test names
testwide$variable <- toupper(as.character(testwide$variable))

# Better column order
testwide <- testwide[ , c("variable", "Negative", "Positive", 
                          "Borderline", "Test Not Performed", "NA")]


# Pretty names
names(testwide)[names(testwide) %in% "variable"] <- "Test"


##################################################
# Individual test results - proportions
testwide.prop <- dcast(
                     melt(testres,
                          id.var = "StudyId", 
                          measure.var = c("tst", "qft", "tspot")),
                     variable ~ value,
                     fun.agg = function(x) { length(x) / nrow(testres) * 100}
)

# Tidy up for printing
# Prettier test names
testwide.prop$variable <- toupper(as.character(testwide.prop$variable))

# Better column order
testwide.prop <- testwide.prop[ , c("variable", "Negative", "Positive", 
                                    "Borderline", "Test Not Performed", "NA")]


# Pretty names
names(testwide.prop)[names(testwide.prop) %in% "variable"] <- "Test"



##################################################
# Aggregate by result class
testagg <- count(testres, var = c("result_class"))

# Make a factor of result_class by descending frequency for plotting later on
testres$plot_class <- factor(testres$result_class,
                             levels = arrange(testagg, freq)$result_class)



##################################################
# Make a factor of result_class for the table - this is more a logical ordering:
# Triple-neg, triple-pos, isolated-pos, isolated-neg
testagg$result_class <- factor(testagg$result_class,
                               levels = c("Triple Negative", "Triple Positive",
                                          "Isolated TST+", "Isolated QFT+", 
                                          "Isolated TSPOT+",
                                          "Isolated TST-", "Isolated QFT-", 
                                          "Isolated TSPOT-",
                                          "Inconclusive")
)
```


Count:

```{r}

# Number positive on each test
dfprint(testwide)

```

Proportion:

```{r}
# Proportion positive on each test
dfprint(testwide.prop)

```




```{r, results="hide",fig.width = 8, fig.height = 8}


ggplot(testres, aes(x = plot_class)) +
  geom_bar() +
  coord_flip() +
  labs(x = "Number of Participants", y = "Result")

```


```{r}

# Add a proportion-of-enrolled indicator
testagg$classprop <- round(testagg$freq / nrow(testres) * 100, 2)

# Pretty names
names(testagg) <- c("Results", "Freq", "Proportion")


dfprint(arrange(testagg, Results))

```


```{r}
### Test Results by Country of Origin
```


```{r}
### Test Results by Risk Factor
```


```{r}
### Treatment Acceptance
```





## Participants with Action Needed
-----------------------------------

### Participants Eligible for Follow-Up
```{r}
fu_report <- calc_fu(to1clean)

names(fu_report) <- c("StudyID", "Enroll Date", 
                      "FU Starts", "FU Ends", "Eligible for FU",
                      "FU Cycle", "Days Left", "Completed")


if(nrow(fu_report) > 0) { dfprint(fu_report) } else {
  cat("No participants require follow-up at this time.")
} 
```



### Triple-Negative Participants to Close
```{r}
# Identify triple neg participants to close (and sort by visit date)
tripnegtoclose <- arrange(closed_check(to1clean), VisitDate)

# Pretty names
names(tripnegtoclose) <- c("StudyId", "Status", "Visit Date", 
                           "TST Neg?", "QFT Neg?",
                           "TSPOT Neg?", "Triple Neg?")

if(nrow(fu_report) > 0) { dfprint(tripnegtoclose) } else {
  cat("No open triple-negative participants at this time.")
} 
```




## Data Quality Checks
------------------------

### Participants with TSTs Read Outside of the 44-76 Hour Window
```{r}
winprob <- tst_win_check(to1clean)


# Pretty names
names(winprob) <- c("StudyId",
                    "Date/Time Placed", "Placed By",
                    "Date/Time Read", "Read By",
                    "Hours Between")


dfprint(winprob)
```



### Participants with Missing TST, QFT, or TSPOT Results
```{r}
# Identify participants with a missing test
testres <- compile_results(to1clean)

missingtest <- subset(testres,
                      subset = (is.na(tst) | is.na(qft) | is.na(tspot)) & 
                               StudyId %in% enrolled,
                      select = c("StudyId", "VisitDate", "tst", "qft", "tspot"))

# Pretty names
names(missingtest) <- c("StudyId", "Visit Date", 
                        "TST Result", "QFT Result", "TSPOT Result")


dfprint(missingtest)
```



### Participants with Pre-enrollment vs. Calculated Age Discrepancies
Age is calculated from participant's reported date of birth and their visit date.
```{r}
ageprob <- age_check(to1clean)

# Pretty names
names(ageprob)[names(ageprob) %in% "preenroll_age"] <- "Pre-enroll Age"
names(ageprob)[names(ageprob) %in% "calc_age"] <- "Calculated Age"
names(ageprob)[names(ageprob) %in% "age_diff"] <- "Difference"


dfprint(ageprob)
```



### Height and Weight
```{r,fig.width=8}
htwts <- htwt_check(to1clean)

# Show the plot
htwts$plot
```



#### Participants with most-outlying heights/weights:
```{r}
# List the outliers

# Slightly nicer names
names(htwts$outlierdf) <- c("StudyId", "Height (inches)", "Weight (pounds)")

dfprint(htwts$outlierdf)
```



#### Enrolled participants missing height and/or weight:
```{r}
# List those missing heights or weights

# Slightly nicer names
names(htwts$missingdf) <- c("StudyId", "Height (inches)", "Weight (pounds)")

dfprint(htwts$missingdf)
```



### TSTs with Rare PPD Lot Numbers
```{r}
lotfreq <- count(to1clean$skintest, "PpdLotNumber")

rare_tst_lot <- subset(to1clean$skintest,
                       subset = PpdLotNumber %in% 
                                lotfreq$PpdLotNumber[lotfreq$freq < 10],
                       select = c("StudyId", "dt_placed", "TstPlacedBy", "PpdLotNumber"))

# Pretty names
names(rare_tst_lot) <- c("StudyId", "Date Placed", "Placed By", "PPD Lot #")


dfprint(arrange(rare_tst_lot, `PPD Lot #`))
```




