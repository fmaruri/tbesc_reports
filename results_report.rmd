



```{r initialize, echo=FALSE,results='hide',message=FALSE,warning=FALSE}
# Initialize!

# Stop R from interpreting strings as factors. 
# When you want factors, you'll know it.
options(stringsAsFactors = FALSE)

# Load up the requisite packages
library(knitr)     # It's a knitr document, after all...
library(to1check)  # All TO1-related functions
library(ggplot2)
library(scales)
library(gridExtra)
library(RColorBrewer)
library(plyr)      # For the count() and arrange() functions
library(mpmisc)    # For printing data.frames nicely
library(lubridate) # For calculating number of weeks remaining

# Set default chunk options
opts_chunk$set(echo = FALSE,
               results = 'asis',
               message = FALSE,
               warning = FALSE,
               error = TRUE,
               fig.width = 10)



# Set up some colors to use throughout
colorwheel <- c( "#F03B20", "#31A354", "#1F78B4")

# Load the ggplot2 theme
source(file.path("..", "css", "theme_tbesc.r"))


# Load the local info (edit this if your results are wrong)
local_facts <- read.csv("local_facts.csv")

# Load the latest cleaned data
load(local_facts$datapath)

# Set aside those who were successfully enrolled - we'll generally disregard 
# those who declined or who didn't complete enrollment 

enrolled <- with(to1clean$master,
    StudyID[!CloseReason %in% c("Didn't complete enrollment", 
                                "Withdrew", 
                                "Not eligible")]
)


# Set up subsets of just the participants enrolled this period
enrolled_master <- to1clean$master[to1clean$master$StudyID %in% enrolled, ]

enrolled_preenroll <- to1clean$preenrollment[to1clean$preenrollment$StudyID 
                                             %in% enrolled, ]



# Set a universal order for the result class variable
result_class_order <- c("Triple Positive", 
                        "Dual Pos, TST and QFT", "Dual Pos, TST and TSPOT",
                        "Dual Pos, QFT and TSPOT", "Isolated QFT+", 
                        "Isolated TSPOT+", "Isolated TST+",
                        "Triple Negative", "Inconclusive")




```

<h1 class='maintitle'>TBESC TO 1 Results Summary: `r local_facts$site`</h1>
<span class='maintitle'>Report generated at `r format(Sys.time())`</span>


```{r}

# Total enrolled so far (I need a better measure of this)
total_enrolled <- length(enrolled)

```

Total Enrolled to Date: `r total_enrolled`





## Eligibility Criteria
```{r eligcrit}

# Get eligibility criteria from the preenrollments
elig.melt <- melt(enrolled_preenroll, 
                  id.var = "StudyID", 
                  measure.var = c("CloseContact", "ForeignBorn", "LtbiPrevalence",
                                  "HighRisk", "HivPositive")
)

# Convert this weird numeric scheme to logical
elig.melt$valuel <- !is.na(elig.melt$value)

# Cast and summarize
elig.wide <- ddply(elig.melt, .var = "variable", .fun = summarise, n = sum(valuel))


# Add a row for "multiple" criteria
ncrit <- ddply(elig.melt, .var = "StudyID", .fun = summarise, n = sum(valuel))

multicrit <- data.frame(variable = "Multiple",
                        n = nrow(ncrit[ncrit$n > 1, ]))
                            
crit.table <- rbind(elig.wide, multicrit)

crit.table$percent <- round(crit.table$n / nrow(enrolled_preenroll), 4) * 100

levels(crit.table$variable) <- c("Close Contact", "Foreign-born", "Local LTBI Prevalence > 25%",
                                 "30+ Days in a High-Risk Country", "HIV+", "Multiple Criteria")

names(crit.table) <- c("Criterion", "Number Enrolled", "Percent of Enrollees")




```

```{r eligcrit_display, result='asis'}

dfprintif(crit.table)

```




## Gender
```{r gender}

# Summarize
gender <- count(enrolled_preenroll, "Gender")

gender$Gender[gender$Gender %in% 1] <- "Female"
gender$Gender[gender$Gender %in% 2] <- "Male"

# Add percentage
gender$percent <- round(gender$freq / sum(gender$freq), 4) * 100

# Pretty names
names(gender) <- c("Gender", "Number Enrolled", "Percent of Enrollees")


```


```{r gender_display}

dfprintif(gender)

```



## Participant Ages
```{r ages, fig.width=10}

ggplot(enrolled_preenroll, aes(x = AgeAtEnrollment, y = ..count../sum(..count..))) +
    geom_bar(binwidth = 2) +
    scale_y_continuous(labels = percent_format()) +
    labs(x = "Age at Enrollment", y = "Percent of Enrollees") +
    theme_tbesc


```

Median Age of Participants: `r median(enrolled_preenroll$AgeAtEnrollment, na.rm = TRUE)`



## Participants by Country of Origin
```{r,results="hide",fig.width = 8, fig.height = 8}

# Tally up participants by their country of birth
birthco <- arrange(count(enrolled_master, var = "BirthCountry"), 
                   freq, BirthCountry)

# BirthCountry = "" or NA indicates a pre-enrolled person
birthco$BirthCountry[birthco$BirthCountry %in% c("", NA)] <- "Pre-enrolled"

# Make BirthCountry a factor - this ensures descending order of the bars
birthco$BirthCountry <- factor(birthco$BirthCountry,  
                               levels = birthco$BirthCountry)



# Plot it
ggplot(birthco, aes(x = BirthCountry, weight = freq)) +
  geom_histogram() +
  coord_flip() +
  labs(title = "Enrollment by country of birth",
       x = "Country of Birth",
       y = "Number Enrolled") +
  theme_tbesc

```


## Test Results

```{r,results='hide'}
##################################
# Summarize participants' individual test results
testres <- compile_results(to1clean)

testres_enrolled <- testres[testres$StudyID %in% enrolled, ]


# Cast all results into a wide table - keep only the results of
# participants enrolled in this period
testwide <- dcast(
                melt(testres_enrolled,
                     id.var = "StudyID", 
                     measure.var = c("tst", "qft", "tspot")),
                variable ~ value,
                fun.agg = length
)

# Tidy up for printing
# Prettier test names
testwide$variable <- toupper(as.character(testwide$variable))

# Better column order
testwide <- testwide[ , c("variable", "Negative", "Positive", 
                          "Borderline", "Indeterminate", "Test Not Performed")]


# Pretty names
names(testwide)[names(testwide) %in% "variable"] <- "Test"


##################################
# Individual test results - proportions
testwide.prop <- dcast(
                     melt(testres_enrolled,
                          id.var = "StudyID", 
                          measure.var = c("tst", "qft", "tspot")),
                     variable ~ value,
                     fun.agg = function(x) { length(x) / nrow(testres_enrolled) * 100}
)

# Tidy up for printing
# Prettier test names
testwide.prop$variable <- toupper(as.character(testwide.prop$variable))

# Better column order
testwide.prop <- testwide.prop[ , c("variable", "Negative", "Positive", 
                                    "Borderline", "Indeterminate", 
                                    "Test Not Performed")]


# Pretty names
names(testwide.prop)[names(testwide.prop) %in% "variable"] <- "Test"



##################################
# Aggregate by result class
testagg <- count(testres_enrolled, var = c("result_class"))

# Make a factor of result_class by descending frequency for plotting later on
testres_enrolled$plot_class <- factor(testres_enrolled$result_class,
                                      levels = arrange(testagg, freq)$result_class)



##################################
# Make a factor of result_class for the table - this is more a logical ordering:
# Triple-neg, triple-pos, isolated-pos, isolated-neg
testagg$result_class <- factor(testagg$result_class,
                               levels = c("Triple Negative", "Triple Positive",
                                          "Isolated TST+", "Isolated QFT+", 
                                          "Isolated TSPOT+",
                                          "Dual Pos, QFT and TSPOT", 
                                          "Dual Pos, TST and TSPOT", 
                                          "Dual Pos, TST and QFT",
                                          "Inconclusive")
)
```


Count:

```{r}

# Number positive on each test
dfprint(testwide)

```

Proportion:

```{r}
# Proportion positive on each test
dfprint(testwide.prop)

```




```{r, results="hide",fig.width = 8, fig.height = 8}


ggplot(testres_enrolled, aes(x = plot_class)) +
  geom_bar() +
  coord_flip() +
  labs(x = "Number of Participants", y = "Result") +
  theme_tbesc

```


```{r}

# Add a proportion-of-enrolled indicator
testagg$classprop <- round(testagg$freq / nrow(testres_enrolled) * 100, 2)

# Pretty names
names(testagg) <- c("Results", "Freq", "Proportion")


dfprint(arrange(testagg, Results))

```



## Test Positivity by Age Group

```{r posbyagegrp}


# Add age to the test results
testage <- merge(x = testres,
                 y = to1clean$preenrollment[ , 
                         c("StudyID", "AgeAtEnrollment")],
                 all.x = TRUE)


# Group by age
testage$age.grp <- NA
testage$age.grp[testage$AgeAtEnrollment >= 2 &
                testage$AgeAtEnrollment <= 5] <- "2-5"
testage$age.grp[testage$AgeAtEnrollment >= 6 &
                testage$AgeAtEnrollment <= 12] <- "6-12"
testage$age.grp[testage$AgeAtEnrollment >= 13 &
                testage$AgeAtEnrollment <= 25] <- "13-25"
testage$age.grp[testage$AgeAtEnrollment >= 26 &
                testage$AgeAtEnrollment <= 39] <- "26-39"
testage$age.grp[testage$AgeAtEnrollment >= 40] <- "40+"

# Make it an ordered factor - keeps plots, tables, etc. in sensible order
testage$age.grp <- factor(testage$age.grp, 
                          levels = c("2-5", "6-12", "13-25", 
                                     "26-39", "40+"),
                          ordered = TRUE
)



# Aggregate by age
testage.agg <- ddply(testage, .var = "age.grp", .fun = summarise,

    n = length(StudyID),
    per.tstpos = sum(tst %in% "Positive") / n,
    per.qftpos = sum(qft %in% "Positive") / n,
    per.tspotpos = sum(tspot %in% "Positive") / n,
    per.tspotbord = sum(tspot %in% "Borderline") / n
                     
)

# Melt it for plotting
testage.melt <- melt(testage.agg, id.vars = c("age.grp", "n"))

# Pretty labels
levels(testage.melt$variable) <- c("TST Positive", 
                                   "QFT Positive",
                                   "TSPOT Positive",
                                   "TSPOT Borderline")


ggplot(testage.melt, 
       aes(x = age.grp, 
           y = value,
           color = variable,
           group = variable)) +
    geom_point(aes(size = n, shape = variable)) +
    geom_line(aes(linetype = variable)) +
    labs(x = "Age at Enrollment", y = "Percent with Result") +
    scale_y_continuous(labels = percent) +
    scale_size_continuous("# of Participants") +
    scale_color_manual("Test", values = brewer.pal(n = 4, name = "Set1")) +
    scale_linetype_discrete("Test") +
    scale_shape_discrete("Test") +
    theme_tbesc

```



## Test Results by Age Group



```{r resultgroupsbyage}
            
# Aggregate results   
ageres <- ddply(testage, .var = "age.grp", .fun = function(x) {
    
    # Aggregate results within the age group
    rescount <- count(x, var = "result_class")
    
    # Calculate each result's percent of the age group
    rescount$per <- round(rescount$freq / nrow(x) * 100, 1)
    
    # Return
    rescount

})


# Make result_class an ordered factor
ageres$result_class <- factor(ageres$result_class,
                              levels = result_class_order)


ggplot(ageres, aes(x = age.grp, weight = per, fill = result_class)) +
    geom_bar(color = "black") +
    labs(x = "Age at Enrollment", y = "Percent of Participants") +
    coord_cartesian(y = c(-1, 60)) +
    scale_y_continuous(breaks = seq(0, 100, 10)) +
    scale_fill_manual("Result Group",
                      values = c(rev(brewer.pal(n = 7, name = "Paired")), 
                                 NA, NA)) +
    theme_tbesc +
    guides(fill = guide_legend(reverse = TRUE))




```



### How much is increasing positivity driven by the triple-positives?

```{r notrippos}

# But actually just reordering the factor and making them invisible
ageres$notrippos <- factor(ageres$result_class,
                           levels = result_class_order[c(2:7, 1, 8, 9)],
                           ordered = TRUE)


ggplot(ageres, aes(x = age.grp, weight = per, fill = notrippos)) +
    geom_bar(color = "black") +
    labs(x = "Age at Enrollment", y = "Percent of Participants") +
    coord_cartesian(y = c(-1, 60)) +
    scale_y_continuous(breaks = seq(0, 100, 10)) +
    scale_fill_manual("Result Group",
                      values = c(rev(brewer.pal(n = 7, 
                                                 name = "Paired")[-7]), 
                                 "honeydew", NA, NA)) +
    theme_tbesc +
    guides(fill = guide_legend(reverse = TRUE))




```


```{r result_age_table}

# Cast ageres into a more suitable table format
ageres.melt <- melt(ageres,
                    id.var = c("result_class", "age.grp"),
                    measure.var = c("freq", "per"))

ageres.wide <- dcast(ageres.melt,
                     result_class ~ age.grp + variable,
                     value.var = "value")

# Convert N columns to integers
ageres.wide$`2-5_freq` <- as.character(ageres.wide$`2-5_freq`)
ageres.wide$`6-12_freq` <- as.character(ageres.wide$`6-12_freq`)
ageres.wide$`13-25_freq` <- as.character(ageres.wide$`13-25_freq`)
ageres.wide$`26-39_freq` <- as.character(ageres.wide$`26-39_freq`)
ageres.wide$`40+_freq` <- as.character(ageres.wide$`40+_freq`)


# Prettier names
names(ageres.wide) <- c("Results",
                        "Ages 2-5: N", "Ages 2-5: %",
                        "Ages 6-12: N", "Ages 6-12: %",
                        "Ages 13-25: N", "Ages 13-25: %",
                        "Ages 26-39: N", "Ages 26-39: %",
                        "Ages 40+: N", "Ages 40+: %")


dfprintif(ageres.wide)

```




## Quantitative Test Results
```{r quantres}


# Set up a color scale for results
resultcolors <- c("#F03B20", "#1F78B4", "#31A354", "grey", "grey", "grey")

names(resultcolors) <- c("Negative", "Positive", 
                         "Borderline",
                         "Indeterminate", "Invalid", "Test Not Performed")


# Set up result factors for nicer ordering
to1clean$qft$result.ord <- factor(to1clean$qft$result,
                                  levels = c("Negative", "Positive",
                                             "Indeterminate"))


to1clean$tspot$result.ord <- factor(to1clean$tspot$result,
                                   levels = c("Negative", "Borderline",
                                              "Positive", "Invalid",
                                              "Test Not Performed"))


ggplot(to1clean$skintest, aes(x = indur_mm)) +
    geom_histogram(aes(fill = result), binwidth = 1) +
    geom_vline(xintercept = 10, color = "red") +
    labs(x = "TST Induration (mm)", 
         y = "Frequency",
         title = "TST Induration Sizes") +
    scale_x_continuous(breaks = seq(0, 100, 5)) +
    scale_fill_manual("Result", values = resultcolors) +
    theme_bw()


ggplot(to1clean$qft, aes(x = tbnil.num)) +
    geom_histogram(aes(fill = result.ord), binwidth = 0.05) +
    geom_vline(xintercept = 0.35, color = "red") +
    labs(x = "TB - Nil (IU/mL)", 
         y = "Frequency",
         title = "Quantiferon TB - Nil Results") +
    scale_x_continuous(breaks = c(seq(-10, 0, 0.5), 0.35, seq(1, 10, 0.5))) +
    scale_fill_manual("Result", values = resultcolors) +
    theme_bw()


ggplot(to1clean$tspot, aes(x = tbnil.max)) +
    geom_histogram(aes(fill = result.ord), binwidth = 1) +
    geom_vline(xintercept = c(5, 8), color = "red") +
    labs(x = "Maximum TB - Nil Result (spots)", 
         y = "Frequency",
         title = "TSPOT TB - Nil Results") +
    scale_x_continuous(breaks = c(seq(-20, 5, 5), 8, seq(10, 100, 5))) +
    scale_fill_manual("Result", values = resultcolors) +
    theme_bw()


```



## Quantitative Test Results By Age
```{r quantres_age}



# Set up defined shapes for the results
resultshapes <- c(15, 3, 18, 13, 13, 13)

names(resultshapes) <- c("Negative", "Positive", 
                         "Borderline",
                         "Indeterminate", "Invalid", "Test Not Performed")


# Merge ages onto quantitative results
tstage <- merge(x = to1clean$skintest,
                y = enrolled_preenroll[c("StudyID", "AgeAtEnrollment")],
                by = "StudyID",
                all.x = TRUE)

qftage <- merge(x = to1clean$qft,
                y = enrolled_preenroll[c("StudyID", "AgeAtEnrollment")],
                by = "StudyID",
                all.x = TRUE)

tspotage <- merge(x = to1clean$tspot,
                  y = enrolled_preenroll[c("StudyID", "AgeAtEnrollment")],
                  by = "StudyID",
                  all.x = TRUE)



ggplot(tstage, aes(x = AgeAtEnrollment, y = indur_mm)) +
    geom_jitter(aes(color = result, shape = result), size = 3, alpha = 0.7) +
    geom_hline(yintercept = 10, color = "red") +
    labs(x = "Age At Enrollment", 
         y = "Induration (mm)",
         title = "TST Induration Sizes by Age (jittered)") +
    scale_x_continuous(breaks = seq(0, 100, 5)) +
    scale_color_manual("Result", values = resultcolors) +
    scale_shape_manual("Result", values = resultshapes) +
    theme_bw()


ggplot(qftage, aes(x = AgeAtEnrollment, y = tbnil.num)) +
    geom_jitter(aes(color = result, shape = result), size = 3, alpha = 0.7) +
    geom_hline(yintercept = 0.35, color = "red") +
    labs(x = "Age At Enrollment", 
         y = "TB - Nil Results (IU/mL)",
         title = "Quantiferon TB - Nil Results by Age (jittered)") +
    scale_x_continuous(breaks = seq(0, 100, 5)) +
    scale_y_continuous(breaks = c(seq(-10, 0, 0.5), 0.35, seq(1, 10, 0.5))) +
    scale_color_manual("Result", values = resultcolors) +
    scale_shape_manual("Result", values = resultshapes) +
    theme_bw()


ggplot(tspotage, aes(x = AgeAtEnrollment, y = tbnil.max)) +
    geom_jitter(aes(color = result, shape = result), size = 3, alpha = 0.7) +
    geom_hline(yintercept = c(5, 8), color = "red") +
    labs(x = "Age At Enrollment", 
         y = "Maximum TB - Nil Result (spots)",
         title = "TSPOT TB - Nil Results by Age (jittered)") +
    scale_x_continuous(breaks = seq(0, 100, 5)) +
    scale_y_continuous(breaks = c(seq(-20, 5, 5), 8, seq(10, 100, 5))) +
    scale_color_manual("Result", values = resultcolors) +
    scale_shape_manual("Result", values = resultshapes) +
    theme_bw()



```


## Test Results Over the Enrollment Period

```{r tests_overtime}

# Aggregate by enrollment month
testres$EnrollMonth <- format(testres$EnrollDate, "%Y-%m")


monthmelt <- melt(subset(testres, EnrollDate >= as.Date("2012-11-01")),
                  id.vars = "EnrollMonth",
                  measure.vars = c("tst", "qft", "tspot"))


# Aggregate
monthcount <- ddply(monthmelt,
                    .var = c("EnrollMonth", "variable"),
                    .fun = summarise,
                    
    n = length(value),
    per.pos = sum(value %in% "Positive") / n,
    per.bord = sum(value %in% "Borderline") / n,
    per.ind = sum(value %in% "Indeterminate") / n
                    
)
    

# Tidy up for plot
levels(monthcount$variable) <- c("TST", "QFT", "TSPOT")


ggplot(monthcount, aes(x = EnrollMonth, 
                      y = per.pos,
                      color = variable)) +
    geom_point(aes(size = n)) +
    geom_line(aes(group = variable, linetype = variable)) +
    expand_limits(y = 0) +
    scale_y_continuous(labels = percent) +
    scale_color_manual("Test", 
                       values = colorwheel[1:3]) +
    scale_linetype_discrete("Test") +
    scale_size_continuous("# Enrolled") +
    labs(x = "Enrollment Month", y = "Percent Positive") +
    theme_tbesc 
    
    




```




## Treatment Outcomes By Test Result


```{r tx_outcomes}

# Summarize the treatment information in DMS
dms_tx <- subset(to1clean$ltbi, 
                 select = c("StudyID", "OfferTreatment", "OfferDate",
                            "AcceptTreatment", "ScriptPickUpDate", 
                            "TreatmentComplete")
)


# Merge onto test results
tx_test <- merge(x = testres,
                 y = dms_tx,
                 by = "StudyID",
                 all.x = TRUE)


# Summarize by single test results
tx_test_melt <- melt(tx_test,
                     id.var = c("StudyID", "OfferTreatment",
                                "AcceptTreatment", "TreatmentComplete"),
                     measure.var = c("tst", "qft", "tspot")
)
                     
result_tx  <- ddply(tx_test_melt, 
                    .var = c("variable", "value"), 
                    .fun = summarise,
                    
    n = length(StudyID),
    n_offered = sum(OfferTreatment, na.rm = TRUE),
    per_offered = round(n_offered / n * 100, 2),
    n_accepted = sum(AcceptTreatment, na.rm = TRUE),
    per_accepted = round(n_accepted / n_offered * 100, 2),
    n_completed = sum(TreatmentComplete, na.rm = TRUE),
    per_completed = round(n_completed / n_accepted * 100, 2)
                    
)


# Subset to just positive tests
pos_tx <- subset(result_tx, value %in% "Positive")

# Relabel variable
pos_tx$variable <- c("TST+", "QFT+", "TSPOT+")




# Summarize by result class                 
result_class_tx  <- ddply(tx_test, 
                    .var = "result_class", 
                    .fun = summarise,
                    
    n = length(StudyID),
    n_offered = sum(OfferTreatment, na.rm = TRUE),
    per_offered = round(n_offered / n * 100, 2),
    n_accepted = sum(AcceptTreatment, na.rm = TRUE),
    per_accepted = round(n_accepted / n_offered * 100, 2),
    n_completed = sum(TreatmentComplete, na.rm = TRUE),
    per_completed = round(n_completed / n_accepted * 100, 2)
                    
)


# Make result class a factor
result_class_tx$result_class <- factor(result_class_tx$result_class,
    levels = c("Triple Positive", 
               "Dual Pos, TST and QFT", "Dual Pos, QFT and TSPOT",
               "Isolated QFT+",
               "Dual Pos, TST and TSPOT", 
               "Isolated TST+", "Isolated TSPOT+",
               "Triple Negative", "Inconclusive"),
    ordered = TRUE)

# Replace NaNs with -- for tidier display
result_class_tx$per_accepted[is.nan(result_class_tx$per_accepted)] <- "--"
result_class_tx$per_completed[is.nan(result_class_tx$per_completed)] <- 
    "--"


# Replace n_accept with zero when no one was offered,
# and n_complete with zero when no one accepted
result_class_tx$n_accepted[result_class_tx$n_offered %in% 0] <- "--"
result_class_tx$n_completed[result_class_tx$n_accepted %in% 0] <- "--"



```

```{r print_pos_tx}


# Prettier names
names(pos_tx) <- c("Result", "drop", "N", 
                   "N Offered", "% Offered",
                   "N Accepted", "% Accepted",
                   "N Completed", "% Completed")


dfprintif(pos_tx[ , names(pos_tx)[!names(pos_tx) %in% "drop"]])



```






## Treatment Outcomes By Result Group


```{r print_class_tx}


# Prettier names
names(result_class_tx) <- c("Result Class", "N", 
                            "N Offered", "% Offered",
                            "N Accepted", "% Accepted",
                            "N Completed", "% Completed")


dfprintif(arrange(result_class_tx, `Result Class`))



```



## Test Results by Country of Origin




## Test Results by Risk Factors








## TB Disease




