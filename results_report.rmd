



```{r initialize, echo=FALSE,results='hide',message=FALSE,warning=FALSE}
# Initialize!

# Stop R from interpreting strings as factors. 
# When you want factors, you'll know it.
options(stringsAsFactors = FALSE)

# Load up the requisite packages
library(knitr)     # It's a knitr document, after all...
library(to1check)  # All TO1-related functions
library(ggplot2)
library(scales)
library(plyr)      # For the count() and arrange() functions
library(mpmisc)    # For printing data.frames nicely
library(lubridate) # For calculating number of weeks remaining

# Set default chunk options
opts_chunk$set(echo = FALSE,
               results = 'asis',
               message = FALSE,
               warning = FALSE,
               error = TRUE)


# Load the local info (edit this if your results are wrong)
local_facts <- read.csv("local_facts.csv")

# Load the latest cleaned data
load(local_facts$datapath)

# Set aside those who were successfully enrolled during the 
# in question - we'll generally disregard those who declined 
# or who didn't complete enrollment 

enrolled <- with(to1clean$master,
    StudyID[!CloseReason %in% c("Didn't complete enrollment", 
                                "Withdrew", 
                                "Not eligible") &
            EnrollDate >= as.Date(local_facts$period_start) &
            EnrollDate <= as.Date(local_facts$period_end)]
)


# Set up subsets of just the participants enrolled this period
enrolled_master <- to1clean$master[to1clean$master$StudyID %in% enrolled, ]

enrolled_preenroll <- to1clean$preenrollment[to1clean$preenrollment$StudyID %in% enrolled, ]




```

<h1 class='maintitle'>TBESC TO 1 Results Summary: `r local_facts$site`</h1>
<h3 class='maintitle'>Enrollment Period: `r paste(local_facts$period_start, "through", local_facts$period_end)`</h3>
<span class='maintitle'>Report generated at `r format(Sys.time())`</span>


```{r}

# Total enrolled so far (I need a better measure of this)
total_enrolled <- length(enrolled)

```

Total Enrolled to Date: `r total_enrolled`





### Eligibility Criteria
```{r eligcrit}

# Get eligibility criteria from the preenrollments
elig.melt <- melt(enrolled_preenroll, 
                  id.var = "StudyID", 
                  measure.var = c("CloseContact", "ForeignBorn", "LtbiPrevalence",
                                  "HighRisk", "HivPositive")
)

# Convert this weird numeric scheme to logical
elig.melt$valuel <- !is.na(elig.melt$value)

# Cast and summarize
elig.wide <- ddply(elig.melt, .var = "variable", .fun = summarise, n = sum(valuel))


# Add a row for "multiple" criteria
ncrit <- ddply(elig.melt, .var = "StudyID", .fun = summarise, n = sum(valuel))

multicrit <- data.frame(variable = "Multiple",
                        n = nrow(ncrit[ncrit$n > 1, ]))
                            
crit.table <- rbind(elig.wide, multicrit)

crit.table$percent <- round(crit.table$n / nrow(enrolled_preenroll), 4) * 100

levels(crit.table$variable) <- c("Close Contact", "Foreign-born", "Local LTBI Prevalence > 25%",
                                 "30+ Days in a High-Risk Country", "HIV+", "Multiple Criteria")

names(crit.table) <- c("Criterion", "Number Enrolled", "Percent of Enrollees")




```

```{r eligcrit_display, result='asis'}

dfprintif(crit.table)

```




### Gender
```{r gender}

# Summarize
gender <- count(enrolled_preenroll, "Gender")

gender$Gender[gender$Gender %in% 1] <- "Female"
gender$Gender[gender$Gender %in% 2] <- "Male"

# Add percentage
gender$percent <- round(gender$freq / sum(gender$freq), 4) * 100

# Pretty names
names(gender) <- c("Gender", "Number Enrolled", "Percent of Enrollees")


```


```{r gender_display}

dfprintif(gender)

```



### Participant Ages
```{r ages, fig.width=10}

ggplot(enrolled_preenroll, aes(x = AgeAtEnrollment, y = ..count../sum(..count..))) +
    geom_bar(binwidth = 2) +
    scale_y_continuous(labels = percent_format()) +
    labs(x = "Age at Enrollment", y = "Percent of Enrollees")


```

Median Age of Participants: `r median(enrolled_preenroll$AgeAtEnrollment, na.rm = TRUE)`



### Participants by Country of Origin
```{r,results="hide",fig.width = 8, fig.height = 8}

# Tally up participants by their country of birth
birthco <- arrange(count(enrolled_master, var = "BirthCountry"), 
                   freq, BirthCountry)

# BirthCountry = "" or NA indicates a pre-enrolled person
birthco$BirthCountry[birthco$BirthCountry %in% c("", NA)] <- "Pre-enrolled"

# Make BirthCountry a factor - this ensures descending order of the bars
birthco$BirthCountry <- factor(birthco$BirthCountry,  
                               levels = birthco$BirthCountry)



# Plot it
ggplot(birthco, aes(x = BirthCountry, weight = freq)) +
  geom_histogram() +
  coord_flip() +
  labs(title = "Enrollment by country of birth",
       x = "Country of Birth",
       y = "Number Enrolled")

```


### Test Results

```{r,results='hide'}
##################################################
# Summarize participants' individual test results
testres <- compile_results(to1clean)

testres_enrolled <- testres[testres$StudyID %in% enrolled, ]


# Cast all results into a wide table - keep only the results of
# participants enrolled in this period
testwide <- dcast(
                melt(testres_enrolled,
                     id.var = "StudyID", 
                     measure.var = c("tst", "qft", "tspot")),
                variable ~ value,
                fun.agg = length
)

# Tidy up for printing
# Prettier test names
testwide$variable <- toupper(as.character(testwide$variable))

# Better column order
testwide <- testwide[ , c("variable", "Negative", "Positive", 
                          "Borderline", "NA")]


# Pretty names
names(testwide)[names(testwide) %in% "variable"] <- "Test"


##################################################
# Individual test results - proportions
testwide.prop <- dcast(
                     melt(testres_enrolled,
                          id.var = "StudyID", 
                          measure.var = c("tst", "qft", "tspot")),
                     variable ~ value,
                     fun.agg = function(x) { length(x) / nrow(testres_enrolled) * 100}
)

# Tidy up for printing
# Prettier test names
testwide.prop$variable <- toupper(as.character(testwide.prop$variable))

# Better column order
testwide.prop <- testwide.prop[ , c("variable", "Negative", "Positive", 
                                    "Borderline", "NA")]


# Pretty names
names(testwide.prop)[names(testwide.prop) %in% "variable"] <- "Test"



##################################################
# Aggregate by result class
testagg <- count(testres_enrolled, var = c("result_class"))

# Make a factor of result_class by descending frequency for plotting later on
testres_enrolled$plot_class <- factor(testres_enrolled$result_class,
                                      levels = arrange(testagg, freq)$result_class)



##################################################
# Make a factor of result_class for the table - this is more a logical ordering:
# Triple-neg, triple-pos, isolated-pos, isolated-neg
testagg$result_class <- factor(testagg$result_class,
                               levels = c("Triple Negative", "Triple Positive",
                                          "Isolated TST+", "Isolated QFT+", 
                                          "Isolated TSPOT+",
                                          "Dual Pos, QFT and TSPOT", 
                                          "Dual Pos, TST and TSPOT", 
                                          "Dual Pos, TST and QFT",
                                          "Inconclusive")
)
```


Count:

```{r}

# Number positive on each test
dfprint(testwide)

```

Proportion:

```{r}
# Proportion positive on each test
dfprint(testwide.prop)

```




```{r, results="hide",fig.width = 8, fig.height = 8}


ggplot(testres_enrolled, aes(x = plot_class)) +
  geom_bar() +
  coord_flip() +
  labs(x = "Number of Participants", y = "Result")

```


```{r}

# Add a proportion-of-enrolled indicator
testagg$classprop <- round(testagg$freq / nrow(testres_enrolled) * 100, 2)

# Pretty names
names(testagg) <- c("Results", "Freq", "Proportion")


dfprint(arrange(testagg, Results))

```



### Test Results by Country of Origin




### Test Results by Risk Factors




### Treatment Acceptance





### Treatment Outcomes





### TB Disease




